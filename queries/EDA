/*  adding key financial metrics: revenue, operating expenses (past SLA losses), gross profit and net profit */

/*  left join item_info table and user_list table with order_list table to get the COGs data needed for calculation of key financial metrics and the user information,
    replacing null values for CoGS with 0.
*/

SELECT  o.*,
        DATE(o.purchaseDate) AS purchaseDate,
        u.location,
        COALESCE(i.CoGS,0) AS itemCoGS,
        o.itemQty * COALESCE(i.CoGS, 0) AS totalCoGS,
        o.orderAmount - (o.itemQty * COALESCE(i.CoGS, 0)) AS grossProfit,
        CASE WHEN isPastSLA = 1 THEN o.orderAmount - (o.orderDiscount + o.shippingDiscount) - (o.itemQty * COALESCE(i.CoGS, 0))
             WHEN isPastSLA = 0 THEN o.orderAmount - (o.itemQty * COALESCE(i.CoGS, 0))
             ELSE 0
        END AS netProfit,
        CASE WHEN isPastSLA = 1 THEN o.orderDiscount + o.shippingDiscount 
             ELSE 0
        END AS pastSLAExpenses

FROM `sprint3-415908.sprint3_4_dataset.order_list` o
LEFT JOIN `sprint3-415908.sprint3_4_dataset.item_info` i
    ON o.skuId = i.skuId
LEFT JOIN `sprint3-415908.sprint3_4_dataset.user_list` u
    ON o.accountId = u.id;
